<!doctype html>
<html lang="en">
  {% load static %}
  {% load roles %}
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}QED Utility{% endblock %}</title>
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'assets/favicon/apple-touch-icon.png' %}?v=2.0">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'assets/favicon/favicon-32x32.png' %}?v=2.0">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'assets/favicon/favicon-16x16.png' %}?v=2.0">
    <link rel="manifest" href="{% static 'assets/favicon/site.webmanifest' %}?v=2.0">
    <link rel="shortcut icon" href="{% static 'assets/favicon/favicon.ico' %}?v=2.0">
    <link rel="stylesheet" href="{% static 'css/base.css' %}?v=2.6" />
    {% block extra_css %}{% endblock %}
  </head>
  <body>
    {% if user.is_authenticated %}
      <nav class="navbar">
        <div class="navbar-content">
          <div class="navbar-left">
            <div class="nav-links">
              <a href="{% url 'dashboard' %}" class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">Dashboard</a>
              <a href="{% url 'tasks' %}" class="nav-link {% if request.resolver_match.url_name == 'tasks' %}active{% endif %}">Tasks</a>
          <a href="#" id="startProcessBtn" class="nav-link" onclick="openStartModal(event)">Start Process</a>
          
          {% if request.user|has_any_role:"Circlecoordinator,Surveycoordinator,designcoordinator" %}
            <div class="dropdown">
                <span class="nav-link dropdown-trigger {% if request.resolver_match.url_name == 'bulk_upload' or request.resolver_match.url_name == 'bulk_delete' %}active{% endif %}" onclick="toggleDropdown(event)">
                    Bulk Operations
                </span>
                <div class="dropdown-content" style="display: none;">
                    <a href="{% url 'bulk_upload' %}">Bulk Upload</a>
                    {% if request.user|has_any_role:"designcoordinator" %}
                        <a href="{% url 'bulk_delete' %}">Bulk Delete</a>
                    {% endif %}
                </div>
            </div>
          {% endif %}

          {% if request.user|has_any_role:"designcoordinator" %}
            <a href="{% url 'process_data' %}" class="nav-link {% if request.resolver_match.url_name == 'process_data' %}active{% endif %}">Process Data</a>
          {% endif %}
            </div>
          </div>

          <div class="app-user-controls">
            <span>{{ user.first_name|default:user.username }}</span>
            <span>|</span>
            <form method="post" action="{% url 'logout' %}" style="display:inline;">
              {% csrf_token %}
              <button type="submit" class="btn-logout">Logout</button>
            </form>
          </div>
        </div>
      </nav>

      <div class="app-container">
        <div class="app-card">
          <main class="app-content">
            {% if messages %}
              <div class="messages" role="status" aria-live="polite">
                {% for message in messages %}
                  <div class="message message--{{ message.tags }}">{{ message }}</div>
                {% endfor %}
              </div>
            {% endif %}
            {% block content %}{% endblock %}
          </main>
        </div>
      </div>
    {% else %}
      {% if messages %}
        <div class="messages" role="status" aria-live="polite" style="position: absolute; top: 0; width: 100%; z-index: 2000;">
          {% for message in messages %}
            <div class="message message--{{ message.tags }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
      {% block login_content %}{% endblock %}
    {% endif %}

    <!-- Global Start Process Modal -->
    <div id="startProcessModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Start a Process</h2>
          <span class="close">&times;</span>
        </div>
        <div class="form-group">
          <label for="processSelect" class="form-label">Select Process</label>
          <select id="processSelect" class="form-control">
            <option value="">-- Select --</option>
          </select>
        </div>
        <div class="modal-actions">
          <button id="goToStartFormBtn" class="btn-outcome" disabled>Next</button>
        </div>
      </div>
    </div>

    <script>
      // Global functions to ensure accessibility
      let processesLoaded = false;

      function toggleDropdown(e) {
          if (e) {
              e.preventDefault();
              e.stopPropagation();
          }
          const trigger = e.currentTarget || e.target.closest('.dropdown-trigger');
          if (!trigger) return;

          const dropdownContent = trigger.nextElementSibling;
          if (dropdownContent && dropdownContent.classList.contains('dropdown-content')) {
              if (dropdownContent.style.display === 'block') {
                  dropdownContent.style.display = 'none';
                  dropdownContent.classList.remove('show');
              } else {
                  // Close other dropdowns first
                  const allDropdowns = document.querySelectorAll('.dropdown-content');
                  allDropdowns.forEach(d => {
                      d.style.display = 'none';
                      d.classList.remove('show');
                  });
                  
                  dropdownContent.style.display = 'block';
                  dropdownContent.classList.add('show');
              }
          }
      }

      function openStartModal(e) {
          if (e) e.preventDefault();
          console.log("QED Utility: Open Modal Triggered");
          const modal = document.getElementById("startProcessModal");
          if (modal) {
              // Force styles to ensure visibility
              modal.style.display = "block";
              modal.style.zIndex = "10000"; // Ensure it's on top
              
              // Debugging visibility
              const style = window.getComputedStyle(modal);
              console.log("Modal Computed Style - Display:", style.display);
              console.log("Modal Computed Style - Z-Index:", style.zIndex);
              console.log("Modal Computed Style - Visibility:", style.visibility);
              console.log("Modal Computed Style - Opacity:", style.opacity);
              
              loadProcessDefinitions();
          } else {
              alert("Error: Modal element not found!");
          }
      }

      function closeStartModal() {
          const modal = document.getElementById("startProcessModal");
          if (modal) modal.style.display = "none";
      }

      function loadProcessDefinitions() {
          if (processesLoaded) return;
          const select = document.getElementById("processSelect");
          if (!select) return;

          // Clear existing except first
          while (select.options.length > 1) {
              select.remove(1);
          }

          const loadingOption = document.createElement("option");
          loadingOption.textContent = "Loading...";
          select.appendChild(loadingOption);

          fetch("/api/process-definitions/")
              .then(response => {
                  if (!response.ok) throw new Error("Status " + response.status);
                  return response.json();
              })
              .then(data => {
                  // Remove loading
                  if (select.options.length > 1) select.remove(1);
                  
                  const definitions = data.data || [];
                  if (definitions.length === 0) {
                      const option = document.createElement("option");
                      option.textContent = "No processes found";
                      option.disabled = true;
                      select.appendChild(option);
                  }
                  
                  definitions.forEach(pd => {
                      const option = document.createElement("option");
                      option.value = pd.id;
                      option.textContent = `${pd.name} (v${pd.version})`;
                      select.appendChild(option);
                  });
                  processesLoaded = true;
              })
              .catch(error => {
                  console.error("Error fetching processes:", error);
                  alert("Failed to load processes: " + error.message);
                  if (select.options.length > 1) select.remove(1);
                  const option = document.createElement("option");
                  option.textContent = "Error loading processes";
                  option.disabled = true;
                  select.appendChild(option);
              });
      }

      document.addEventListener('DOMContentLoaded', function() {
        console.log("QED Utility: DOM Loaded");
        
        const modal = document.getElementById("startProcessModal");
        const closeSpan = document.querySelector("#startProcessModal .close");
        const nextBtn = document.getElementById("goToStartFormBtn");
        const select = document.getElementById("processSelect");

        if (closeSpan) {
            closeSpan.onclick = closeStartModal;
        }

        window.onclick = function(event) {
            const modal = document.getElementById("startProcessModal");
            if (event.target == modal) {
                closeStartModal();
            }

            // Close dropdowns if clicking outside
            if (!event.target.closest('.dropdown-trigger') && !event.target.closest('.dropdown-content')) {
                const dropdowns = document.getElementsByClassName("dropdown-content");
                for (let i = 0; i < dropdowns.length; i++) {
                    const openDropdown = dropdowns[i];
                    openDropdown.style.display = 'none';
                    openDropdown.classList.remove('show');
                }
            }
        };
        
        if (select) {
            select.onchange = function() {
                if (nextBtn) nextBtn.disabled = !this.value;
            };
        }
        
        if (nextBtn) {
            nextBtn.onclick = function() {
                const processId = select.value;
                if (processId) {
                    window.location.href = `/tasks/start/${encodeURIComponent(processId)}/`;
                }
            };
        }
      });
    </script>

    {% block extra_js %}{% endblock %}
  </body>
</html>
