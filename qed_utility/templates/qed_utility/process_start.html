{% extends "qed_utility/base.html" %}
{% load static %}

{% block title %}Start Process | QED {% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/tasks.css' %}?v=1.0" />
{% endblock %}

{% block content %}
<div class="task-detail-container">
  <div class="task-header">
    <div class="task-title-group">
      <h2 class="task-title">
        {% if process_def and process_def.name %}
          Start: {{ process_def.name }}
        {% else %}
          Start Process
        {% endif %}
      </h2>
      <div class="task-meta-info">
        <span class="task-meta-item">
          <span class="task-meta-label">Definition ID:</span> {{ process_definition_id }}
        </span>
        {% if process_def and process_def.version %}
        <span class="task-meta-item">
          <span class="task-meta-label">Version:</span> {{ process_def.version }}
        </span>
        {% endif %}
      </div>
    </div>
  </div>

  {% if submit_error %}
    <div class="alert alert-error">{{ submit_error }}</div>
  {% endif %}

  <form method="post">
    {% csrf_token %}
    
    {% if form and form.fields %}
      <div class="task-form-grid">
        {% for field in form.fields %}
          {% if field.type == 'horizontal-line' %}
             <div style="grid-column: 1 / -1; border-bottom: 1px solid #e2e8f0; margin: 1rem 0;"></div>
          {% else %}
          <div class="form-group" {% if field.type == 'multi-line-text' %}style="grid-column: 1 / -1;"{% endif %}>
            <label class="form-label" for="{{ field.id }}">{{ field.name|default:field.id }}</label>
            
            {% if field.options %}
              <select id="{{ field.id }}" name="{{ field.id }}" class="form-control" {% if field.readOnly %}disabled{% endif %} {% if field.required %}required{% endif %}>
                <option value="">Select...</option>
                {% for opt in field.options %}
                  <option value="{{ opt.name }}">{{ opt.name }}</option>
                {% endfor %}
              </select>
            {% elif field.type == 'date' %}
               <input
                type="date"
                id="{{ field.id }}"
                name="{{ field.id }}"
                class="form-control"
                value="{{ field.value|default_if_none:'' }}"
                {% if field.readOnly %}readonly{% endif %}
                {% if field.required %}required{% endif %}
               />
            {% elif field.type == 'multi-line-text' %}
               <textarea
                id="{{ field.id }}"
                name="{{ field.id }}"
                class="form-control"
                rows="4"
                {% if field.readOnly %}readonly{% endif %}
                {% if field.required %}required{% endif %}
               >{{ field.value|default_if_none:'' }}</textarea>
            {% else %}
              <input
                type="{{ field.type|default:'text' }}" 
                id="{{ field.id }}"
                name="{{ field.id }}"
                data-type="{{ field.type }}"
                class="form-control"
                value="{{ field.value|default_if_none:'' }}"
                {% if field.readOnly %}readonly{% endif %}
                {% if field.required %}required{% endif %}
              />
            {% endif %}
          </div>
          {% endif %}
        {% endfor %}
      </div>

      <div class="form-actions">
        {% if form.outcomes %}
          {% for outcome in form.outcomes %}
            <button type="submit" name="outcome" value="{{ outcome.name }}" class="btn-outcome">{{ outcome.name }}</button>
          {% endfor %}
        {% else %}
          <button type="submit" class="btn-outcome">Start Process</button>
        {% endif %}
      </div>

    {% else %}
      <div class="alert alert-success" style="background-color: #f0f9ff; border-color: #bae6fd; color: #0369a1;">
        <p style="margin: 0; font-weight: 500;">
          {% if process_def %}
             Ready to start "{{ process_def.name }}".
          {% else %}
             Ready to start process.
          {% endif %}
        </p>
        <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
          This process does not require any additional information to start.
        </p>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn-outcome">Start Process</button>
      </div>
    {% endif %}
  </form>

  <a href="{% url 'tasks' %}" class="back-link">Cancel</a>
</div>

<style>
  .autocomplete-items {
    position: absolute;
    border: 1px solid #d4d4d4;
    border-bottom: none;
    border-top: none;
    z-index: 99;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 200px;
    overflow-y: auto;
    background-color: #fff;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    border-radius: 0 0 0.375rem 0.375rem;
  }
  .autocomplete-item {
    padding: 10px;
    cursor: pointer;
    background-color: #fff;
    border-bottom: 1px solid #d4d4d4;
    color: #333;
    font-size: 0.875rem;
  }
  .autocomplete-item:hover {
    background-color: #e9e9e9;
  }
  .autocomplete-active {
    background-color: #3b82f6 !important;
    color: #ffffff !important;
  }
  .form-group {
      position: relative;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    let users = [];
    let groups = [];

    // Fetch Users
    fetch('/api/flowable-users')
        .then(response => response.json())
        .then(data => { users = data; })
        .catch(err => console.error('Error loading users:', err));

    // Fetch Groups
    fetch('/api/flowable-groups')
        .then(response => response.json())
        .then(data => { groups = data; })
        .catch(err => console.error('Error loading groups:', err));

    function autocomplete(inp, type) {
        let currentFocus;
        inp.addEventListener("input", function(e) {
            let a, b, i, val = this.value;
            closeAllLists();
            if (!val) { return false;}
            currentFocus = -1;
            
            a = document.createElement("DIV");
            a.setAttribute("id", this.id + "autocomplete-list");
            a.setAttribute("class", "autocomplete-items");
            this.parentNode.appendChild(a);
            
            let list = (type === 'user') ? users : groups;
            let count = 0;
            
            for (i = 0; i < list.length; i++) {
                let item = list[i];
                let match = false;
                let display = "";
                let id = item.id;
                
                if (type === 'user') {
                    let name = item.name || "";
                    let email = item.email || "";
                    if (name.toLowerCase().includes(val.toLowerCase()) || 
                        id.toLowerCase().includes(val.toLowerCase()) ||
                        email.toLowerCase().includes(val.toLowerCase())) {
                        match = true;
                        display = `<strong>${name}</strong> (${id})`;
                    }
                } else {
                     let name = item.name || "";
                     if (name.toLowerCase().includes(val.toLowerCase()) || 
                         id.toLowerCase().includes(val.toLowerCase())) {
                         match = true;
                         display = `<strong>${name}</strong> (${id})`;
                     }
                }

                if (match) {
                    b = document.createElement("DIV");
                    b.className = "autocomplete-item";
                    b.innerHTML = display;
                    b.innerHTML += "<input type='hidden' value='" + id + "'>";
                    b.addEventListener("click", function(e) {
                        inp.value = this.getElementsByTagName("input")[0].value;
                        closeAllLists();
                    });
                    a.appendChild(b);
                    count++;
                    if (count > 15) break; 
                }
            }
        });
        
        inp.addEventListener("keydown", function(e) {
            let x = document.getElementById(this.id + "autocomplete-list");
            if (x) x = x.getElementsByTagName("div");
            if (e.keyCode == 40) { // DOWN
                currentFocus++;
                addActive(x);
            } else if (e.keyCode == 38) { // UP
                currentFocus--;
                addActive(x);
            } else if (e.keyCode == 13) { // ENTER
                e.preventDefault();
                if (currentFocus > -1) {
                    if (x) x[currentFocus].click();
                }
            }
        });
        
        function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            x[currentFocus].classList.add("autocomplete-active");
        }
        
        function removeActive(x) {
            for (let i = 0; i < x.length; i++) {
                x[i].classList.remove("autocomplete-active");
            }
        }
        
        function closeAllLists(elmnt) {
            let x = document.getElementsByClassName("autocomplete-items");
            for (let i = 0; i < x.length; i++) {
                if (elmnt != x[i] && elmnt != inp) {
                    x[i].parentNode.removeChild(x[i]);
                }
            }
        }
        
        document.addEventListener("click", function (e) {
            closeAllLists(e.target);
        });
    }

    const inputs = document.querySelectorAll('input.form-control');
    inputs.forEach(input => {
        const id = input.id.toLowerCase();
        const type = (input.getAttribute('data-type') || "").toLowerCase();
        
        // Check for user fields
        if (type === 'people' || type === 'user' || id.includes('user') || id.includes('assignee')) {
            autocomplete(input, 'user');
        } 
        // Check for group fields
        else if (type === 'group' || type === 'functional-group' || id.includes('group')) {
            autocomplete(input, 'group');
        }
    });
});
</script>
{% endblock %}
